<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>å£°è‰²ã‚¹ã‚³ãƒ¼ãƒ— - Voice Color Scope</title>
    <!-- OGP Settings -->
    <meta property="og:title" content="å£°è‰²ã‚¹ã‚³ãƒ¼ãƒ— - Voice Color Scope">
    <meta property="og:description" content="ã‚ãªãŸã®å£°ã‚’åˆ†æã—ã¦ã€Œè‰²ã€ã§è¡¨ç¾ã—ã¾ã™ã€‚å£°ã®ã‚¿ã‚¤ãƒ—ã€éŸ³åŸŸã€ãŠã™ã™ã‚ã®æ›²ã‚‚è¨ºæ–­ï¼">
    <meta property="og:type" content="website">
    <meta property="og:url" content="https://example.com/">
    <meta property="og:image" content="https://placehold.co/1200x630/a1c4fd/ffffff?text=Voice+Color+Scope">
    <meta name="twitter:card" content="summary_large_image">
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns=%22http://www.w3.org/2000/svg%22 viewBox=%220 0 100 100%22><text y=%22.9em%22 font-size=%2290%22>ğŸ¤</text></svg>">
    <style>
        :root {
            --main-bg: #fdfdfd;
            --glass-white: rgba(255, 255, 255, 0.7);
            --rainbow: linear-gradient(45deg, #ff9a9e, #fad0c4, #a1c4fd, #c2e9fb, #d4fc79);
        }

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            margin: 0;
            padding: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            min-height: 100vh;
            background: var(--main-bg);
            font-family: 'Helvetica Neue', Arial, 'Hiragino Kaku Gothic ProN', 'Hiragino Sans', sans-serif;
            color: #444;
        }

        .container {
            text-align: center;
            background: var(--glass-white);
            backdrop-filter: blur(10px);
            padding: 2rem;
            border-radius: 30px;
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.05);
            width: 90%;
            max-width: 600px;
        }

        h1 {
            font-weight: 300;
            letter-spacing: 2px;
            margin-bottom: 1rem;
            background: var(--rainbow);
            background-clip: text;
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
        }

        .mode-tabs {
            display: flex;
            gap: 10px;
            justify-content: center;
            margin-bottom: 30px;
        }

        .mode-tab {
            padding: 10px 25px;
            border: 2px solid #ddd;
            border-radius: 25px;
            background: transparent;
            cursor: pointer;
            transition: 0.3s;
            font-size: 1rem;
            color: #888;
        }

        .mode-tab.active {
            background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
            border-color: #a1c4fd;
            color: #fff;
        }

        .mode-content {
            display: none;
        }

        .mode-content.active {
            display: block;
        }

        #chart-container,
        #chart-container-precision {
            text-align: center;
            margin: 20px 0;
        }

        canvas {
            max-width: 100%;
            height: auto;
            width: 280px !important;
            height: 280px !important;
        }

        .controls {
            text-align: center;
            margin: 20px 0;
        }

        button {
            padding: 12px 30px;
            font-size: 1rem;
            border: none;
            border-radius: 50px;
            background: #fff;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.1);
            cursor: pointer;
            transition: 0.3s;
            color: #444;
        }

        button:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(0, 0, 0, 0.15);
        }

        button:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        .status {
            text-align: center;
            margin: 15px 0;
            color: #555;
        }

        /* è‰²è¡¨ç¤º */
        .voice-color {
            margin: 15px auto;
            padding: 15px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            border-radius: 20px;
            display: none;
            align-items: center;
            justify-content: center;
            gap: 20px;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .voice-color.active {
            display: flex;
        }

        .color-display {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            flex-shrink: 0;
        }

        .color-info {
            text-align: left;
        }

        .color-value {
            font-size: 0.9rem;
            color: #666;
            margin-bottom: 5px;
        }

        .color-hex {
            font-size: 1.5rem;
            font-weight: bold;
            font-family: 'Courier New', monospace;
            color: #333;
        }

        /* éŒ²éŸ³é€²æ— */
        .recording-progress {
            width: 100%;
            height: 10px;
            background: #eee;
            border-radius: 10px;
            overflow: hidden;
            margin: 20px 0;
            display: none;
        }

        .recording-progress.active {
            display: block;
        }

        .progress-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.3s;
        }

        /* éŒ²éŸ³ã‚¬ã‚¤ãƒ‰ */
        .recording-guide {
            background: rgba(161, 196, 253, 0.2);
            padding: 20px;
            border-radius: 15px;
            margin: 20px 0;
            line-height: 1.8;
            display: none;
        }

        .recording-guide.active {
            display: block;
        }

        .guide-title {
            font-size: 1.1rem;
            font-weight: bold;
            margin-bottom: 10px;
            color: #ff6b6b;
        }

        /* éŒ²éŸ³ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ */
        .recording-indicator {
            background: rgba(102, 126, 234, 0.1);
            padding: 12px;
            border-radius: 10px;
            margin: 15px 0;
            text-align: center;
        }

        .volume-bar-container {
            width: 100%;
            height: 20px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 10px;
            overflow: hidden;
        }

        .volume-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            width: 0%;
            transition: width 0.1s ease;
            border-radius: 10px;
        }

        /* çµæœè¡¨ç¤º */
        .result {
            margin: 15px 0;
            padding: 15px;
            background: rgba(255, 255, 255, 0.3);
            backdrop-filter: blur(5px);
            border-radius: 20px;
            display: none;
            border: 1px solid rgba(255, 255, 255, 0.3);
        }

        .result.active {
            display: block;
        }

        .result-item {
            margin: 10px 0;
            font-size: 1rem;
        }

        .result-label {
            font-weight: bold;
            color: #555;
        }

        /* éŸ³åŸŸè¡¨ç¤º */
        .vocal-range {
            margin: 20px 0;
            padding: 20px;
            background: linear-gradient(135deg, rgba(161, 196, 253, 0.15), rgba(194, 233, 251, 0.15));
            border-radius: 20px;
        }

        .vocal-range h3 {
            margin: 0 0 15px 0;
            color: #555;
        }

        .range-bar {
            position: relative;
            height: 60px;
            background: linear-gradient(90deg, #4A90E2 0%, #48DBFB 25%, #1DD1A1 50%, #FFC837 75%, #FF6B6B 100%);
            border-radius: 10px;
            margin: 15px 0;
        }

        .range-marker {
            position: absolute;
            width: 3px;
            height: 70px;
            background: #fff;
            box-shadow: 0 0 10px rgba(0, 0, 0, 0.5);
            top: -5px;
        }

        .range-label {
            position: absolute;
            font-size: 0.9rem;
            font-weight: bold;
            background: #fff;
            padding: 3px 10px;
            border-radius: 10px;
            box-shadow: 0 2px 5px rgba(0, 0, 0, 0.1);
            white-space: nowrap;
        }

        /* ãŠã™ã™ã‚æ›² */
        .song-recommendations {
            margin-top: 20px;
        }

        .song-item {
            padding: 12px;
            margin: 8px 0;
            background: rgba(255, 255, 255, 0.6);
            border-radius: 15px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            transition: 0.3s;
        }

        .song-item:hover {
            background: rgba(255, 255, 255, 0.9);
            transform: translateX(5px);
        }

        .song-info {
            flex: 1;
        }

        .song-title {
            font-weight: bold;
            color: #333;
        }

        .song-artist {
            font-size: 0.85rem;
            color: #666;
        }

        .song-match {
            font-size: 1.1rem;
            font-weight: bold;
            background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
            color: #fff;
            padding: 5px 15px;
            border-radius: 20px;
        }

        /* ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´° */
        .parameter-details {
            margin-top: 20px;
            background: linear-gradient(135deg, rgba(161, 196, 253, 0.1), rgba(194, 233, 251, 0.1));
            border-radius: 20px;
            padding: 20px;
        }

        .parameter-details h3 {
            margin: 0 0 15px 0;
            color: #555;
        }

        .parameter-item {
            margin: 12px 0;
            padding: 10px;
            background: rgba(255, 255, 255, 0.5);
            border-radius: 10px;
        }

        .parameter-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .parameter-name {
            font-weight: bold;
            color: #333;
            font-size: 1rem;
        }

        .parameter-value {
            font-size: 1.1rem;
            color: #667eea;
            font-weight: bold;
        }

        .parameter-bar-container {
            width: 100%;
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 5px;
        }

        .parameter-bar {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            border-radius: 4px;
            transition: width 0.5s ease;
        }

        .parameter-description {
            font-size: 0.85rem;
            color: #666;
            margin-top: 5px;
        }

        /* ãƒ•ãƒƒã‚¿ãƒ¼ */
        footer {
            margin-top: 50px;
            margin-bottom: 20px;
            text-align: center;
            font-size: 0.8rem;
            color: #888;
        }

        footer a {
            color: #667eea;
            text-decoration: none;
            margin: 0 10px;
            cursor: pointer;
        }

        footer a:hover {
            text-decoration: underline;
        }

        /* ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ */
        .modal {
            display: none;
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.5);
            backdrop-filter: blur(5px);
        }

        .modal-content {
            background-color: #fff;
            margin: 10% auto;
            padding: 30px;
            border-radius: 20px;
            width: 90%;
            max-width: 600px;
            box-shadow: 0 5px 30px rgba(0, 0, 0, 0.3);
            position: relative;
            max-height: 80vh;
            overflow-y: auto;
        }

        .close-modal {
            color: #aaa;
            float: right;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
        }

        .close-modal:hover {
            color: #000;
        }

        .modal-body h2 {
            margin-bottom: 20px;
            color: #333;
            border-bottom: 2px solid #eee;
            padding-bottom: 10px;
        }

        .modal-body h3 {
            margin-top: 20px;
            margin-bottom: 10px;
            color: #555;
            font-size: 1.1rem;
        }

        .modal-body p {
            line-height: 1.6;
            margin-bottom: 10px;
            color: #666;
        }

        .modal-body ul {
            margin-bottom: 10px;
            padding-left: 20px;
            color: #666;
        }

        /* ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ‰ãƒ­ãƒ¯ãƒ¼ */
        .drawer-container {
            position: fixed;
            bottom: 20px;
            right: 20px;
            z-index: 900;
            display: flex;
            flex-direction: column;
            align-items: flex-end;
        }

        .drawer-toggle {
            background: linear-gradient(135deg, #a1c4fd, #c2e9fb);
            color: #fff;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 1.5rem;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            cursor: pointer;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            user-select: none;
        }

        .drawer-toggle:hover {
            transform: scale(1.1);
        }

        .drawer-content {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            margin-bottom: 15px;
            box-shadow: 0 5px 25px rgba(0, 0, 0, 0.15);
            width: 280px;
            transform-origin: bottom right;
            transform: scale(0);
            opacity: 0;
            transition: all 0.3s cubic-bezier(0.175, 0.885, 0.32, 1.275);
            pointer-events: none;
            position: absolute;
            bottom: 60px;
            right: 0;
        }

        .drawer-content.active {
            transform: scale(1);
            opacity: 1;
            pointer-events: auto;
        }

        .drawer-section {
            margin-bottom: 15px;
        }

        .drawer-section:last-child {
            margin-bottom: 0;
        }

        .drawer-title {
            font-size: 0.9rem;
            font-weight: bold;
            color: #888;
            margin-bottom: 8px;
            border-bottom: 1px solid #eee;
            padding-bottom: 5px;
            display: block;
        }

        .creator-link {
            display: flex;
            align-items: center;
            gap: 10px;
            text-decoration: none;
            color: #333;
            font-weight: bold;
            padding: 8px;
            border-radius: 10px;
            transition: background 0.2s;
        }

        .creator-link:hover {
            background: aliceblue;
            color: #0056b3;
        }

        .thanks-list {
            list-style: none;
            padding: 0;
            margin: 0;
        }

        .thanks-item {
            font-size: 0.9rem;
            color: #555;
            padding: 4px 0;
            padding-left: 10px;
            border-left: 3px solid #e0e0e0;
            margin-bottom: 5px;
        }
    </style>
</head>

<body>
    <div class="container">
        <h1>ğŸ¤ å£°è‰²ã‚¹ã‚³ãƒ¼ãƒ—</h1>

        <!-- ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿ -->
        <div class="mode-tabs">
            <button class="mode-tab active" data-mode="realtime">ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æ</button>
            <button class="mode-tab" data-mode="precision">ç²¾å¯†åˆ†æ</button>
        </div>

        <!-- ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æãƒ¢ãƒ¼ãƒ‰ -->
        <div class="mode-content active" id="realtimeMode">
            <p class="status">ãƒã‚¤ã‚¯ã§å£°ã‚’åˆ†æã—ã¾ã™</p>
            <div id="chart-container">
                <canvas id="radarChart" width="500" height="500"></canvas>
            </div>
            <div class="controls">
                <button id="startBtn">åˆ†æã‚’é–‹å§‹ã™ã‚‹</button>
            </div>
            <div class="voice-color" id="voiceColorRealtime">
                <div class="color-display" id="colorDisplayRealtime"></div>
                <div class="color-info">
                    <div class="color-value" id="colorValueRealtime">--</div>
                    <div class="color-hex" id="colorHexRealtime">--</div>
                </div>
            </div>
            <p class="status" id="statusRealtime">åˆ†æã‚’é–‹å§‹ã—ã¦ãã ã•ã„</p>
        </div>

        <!-- ç²¾å¯†åˆ†æãƒ¢ãƒ¼ãƒ‰ -->
        <div class="mode-content" id="precisionMode">
            <p class="status">30ç§’é–“ã®éŒ²éŸ³ã§è©³ç´°åˆ†æã—ã¾ã™</p>
            <div id="chart-container-precision">
                <canvas id="radarChartPrecision" width="400" height="400"></canvas>
            </div>
            <div class="controls">
                <button id="recordBtn">éŒ²éŸ³ã‚’é–‹å§‹ã™ã‚‹</button>
            </div>
            <div class="recording-progress" id="recordingProgress">
                <div class="progress-bar" id="progressBar"></div>
            </div>
            <div class="recording-guide" id="recordingGuide">
                <p class="guide-title">ğŸ“¢ ä»¥ä¸‹ã®æ–‡ç« ã‚’è‡ªç„¶ãªå£°ã§èª­ã‚“ã§ãã ã•ã„</p>
                ã‚ãªãŸã®å£°ã¯ã€ä¸–ç•Œã«ä¸€ã¤ã ã‘ã®ãƒ¦ãƒ‹ãƒ¼ã‚¯ãªæ¥½å™¨ã§ã™ã€‚é«˜ã•ã€ã‚¯ãƒªã‚¢ã•ã€ãƒ‘ãƒ¯ãƒ¼ã€è‰¶ã€æŸ”ã‚‰ã‹ã•ã€éŸ¿ãã¨ã„ã†6ã¤ã®è¦ç´ ãŒçµ„ã¿åˆã‚ã•ã‚Šã€ã‚ãªãŸã ã‘ã®éŸ³è‰²ã‚’ä½œã‚Šå‡ºã—ã¦ã„ã¾ã™ã€‚ä»Šã€ã“ã®30ç§’é–“ã§ã‚ãªãŸã®å£°ã®å€‹æ€§ã‚’æ¸¬å®šã—ã¦ã„ã¾ã™ã€‚ãƒªãƒ©ãƒƒã‚¯ã‚¹ã—ã¦è‡ªç„¶ãªå£°ã§è©±ã—ãŸã‚Šã€å¥½ããªæ­Œã‚’æ­Œã£ãŸã‚Šã—ã¦ã¿ã¦ãã ã•ã„ã€‚ã“ã®åˆ†æã«ã‚ˆã£ã¦ã€ã‚ãªãŸã®å£°ã®æœ€é«˜éŸ³ã‚„æœ€ä½éŸ³ã€ãã—ã¦å£°è³ªã®ã‚¿ã‚¤ãƒ—ãŒæ˜ã‚‰ã‹ã«ãªã‚Šã¾ã™ã€‚å£°ã¯æ„Ÿæƒ…ã‚’ä¼ãˆã€äººã¨äººã¨ã‚’ã¤ãªãå¤§åˆ‡ãªã‚³ãƒŸãƒ¥ãƒ‹ã‚±ãƒ¼ã‚·ãƒ§ãƒ³ãƒ„ãƒ¼ãƒ«ã§ã™ã€‚
            </div>

            <!-- éŒ²éŸ³ã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼ -->
            <div class="recording-indicator" id="recordingIndicator" style="display: none;">
                <div style="margin-bottom: 8px; font-size: 0.9rem; color: #666;">
                    éŸ³å£°èªè­˜ä¸­...
                </div>
                <div class="volume-bar-container">
                    <div class="volume-bar" id="volumeBar"></div>
                </div>
            </div>

            <!-- ç²¾å¯†åˆ†æçµæœ -->
            <div class="result" id="precisionResult">
                <!-- è‰²è¡¨ç¤º -->
                <div class="voice-color active" id="voiceColorPrecision">
                    <div class="color-display" id="colorDisplayPrecision"></div>
                    <div class="color-info">
                        <div class="color-value" id="colorValuePrecision">--</div>
                        <div class="color-hex" id="colorHexPrecision">--</div>
                    </div>
                </div>

                <!-- éŸ³åŸŸè¡¨ç¤º -->
                <div class="vocal-range">
                    <h3>ğŸµ ã‚ãªãŸã®éŸ³åŸŸ</h3>
                    <div class="result-item">
                        <span class="result-label">æœ€é«˜éŸ³:</span>
                        <span id="highestNote" style="font-size: 1.2rem; color: #ff6b6b;">--</span>
                    </div>
                    <div class="range-bar" id="rangeBar"></div>
                    <div class="result-item">
                        <span class="result-label">æœ€ä½éŸ³:</span>
                        <span id="lowestNote" style="font-size: 1.2rem; color: #1dd1a1;">--</span>
                    </div>
                    <div class="result-item">
                        <span class="result-label">éŸ³åŸŸå¹…:</span>
                        <span id="vocalRange">--</span>
                    </div>
                </div>

                <div class="result-item">
                    <span class="result-label">å£°è³ªã‚¿ã‚¤ãƒ—:</span>
                    <span id="voiceType">--</span>
                </div>

                <!-- ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´° -->
                <div class="parameter-details">
                    <h3>ğŸ“Š å£°ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°</h3>

                    <div class="parameter-item">
                        <div class="parameter-header">
                            <span class="parameter-name">ğŸµ é«˜ã•</span>
                            <span class="parameter-value" id="param-height">--</span>
                        </div>
                        <div class="parameter-bar-container">
                            <div class="parameter-bar" id="bar-height"></div>
                        </div>
                        <div class="parameter-description">é«˜ã„: é«˜éŸ³ãƒ»æ˜ã‚‹ã„å£° / ä½ã„: ä½éŸ³ãƒ»è½ã¡ç€ã„ãŸå£°</div>
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-header">
                            <span class="parameter-name">âœ¨ ã‚¯ãƒªã‚¢ã•</span>
                            <span class="parameter-value" id="param-clarity">--</span>
                        </div>
                        <div class="parameter-bar-container">
                            <div class="parameter-bar" id="bar-clarity"></div>
                        </div>
                        <div class="parameter-description">é«˜ã„: ãƒã‚­ãƒã‚­ã—ãŸå£° / ä½ã„: æŸ”ã‚‰ã‹ãå„ªã—ã„å£°</div>
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-header">
                            <span class="parameter-name">ğŸ’ª ãƒ‘ãƒ¯ãƒ¼</span>
                            <span class="parameter-value" id="param-power">--</span>
                        </div>
                        <div class="parameter-bar-container">
                            <div class="parameter-bar" id="bar-power"></div>
                        </div>
                        <div class="parameter-description">é«˜ã„: åŠ›å¼·ã„å£° / ä½ã„: ç¹Šç´°ã§ç©ã‚„ã‹ãªå£°</div>
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-header">
                            <span class="parameter-name">ğŸŒŸ è‰¶</span>
                            <span class="parameter-value" id="param-gloss">--</span>
                        </div>
                        <div class="parameter-bar-container">
                            <div class="parameter-bar" id="bar-gloss"></div>
                        </div>
                        <div class="parameter-description">é«˜ã„: è¼ãã®ã‚ã‚‹å£° / ä½ã„: è½ã¡ç€ã„ãŸæ·±ã¿ã®ã‚ã‚‹å£°</div>
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-header">
                            <span class="parameter-name">ğŸŒ¸ æŸ”ã‚‰ã‹ã•</span>
                            <span class="parameter-value" id="param-softness">--</span>
                        </div>
                        <div class="parameter-bar-container">
                            <div class="parameter-bar" id="bar-softness"></div>
                        </div>
                        <div class="parameter-description">é«˜ã„: æ»‘ã‚‰ã‹ã§å„ªã—ã„å£° / ä½ã„: ã—ã£ã‹ã‚Šã—ãŸèŠ¯ã®ã‚ã‚‹å£°</div>
                    </div>

                    <div class="parameter-item">
                        <div class="parameter-header">
                            <span class="parameter-name">ğŸ”” éŸ¿ã</span>
                            <span class="parameter-value" id="param-resonance">--</span>
                        </div>
                        <div class="parameter-bar-container">
                            <div class="parameter-bar" id="bar-resonance"></div>
                        </div>
                        <div class="parameter-description">é«˜ã„: éŸ¿ãã®ã‚ã‚‹è±Šã‹ãªå£° / ä½ã„: è¦ªå¯†ã§èº«è¿‘ãªå£°</div>
                    </div>
                </div>

                <!-- ãŠã™ã™ã‚æ›² -->
                <div class="song-recommendations" id="songRecommendations" style="display: none;">
                    <h3 style="color: #555;">ğŸ¤ ã‚ãªãŸã«ãŠã™ã™ã‚ã®æ›²</h3>
                    <div id="songList"></div>
                </div>
            </div>

            <p class="status" id="statusPrecision">éŒ²éŸ³ãƒœã‚¿ãƒ³ã‚’æŠ¼ã—ã¦ãã ã•ã„</p>
        </div>
    </div>

    <!-- ãƒ•ãƒƒã‚¿ãƒ¼ -->
    <footer>
        <a id="openPrivacy">ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</a> |
        <a id="openTerms">åˆ©ç”¨è¦ç´„</a> |
        <span>&copy; 2026 Voice Color Scope</span>
    </footer>
    </div>

    <!-- ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆãƒ‰ãƒ­ãƒ¯ãƒ¼ -->
    <div class="drawer-container">
        <!-- ãƒ‰ãƒ­ãƒ¯ãƒ¼ã®ä¸­èº« -->
        <div class="drawer-content" id="drawerContent">
            <div class="drawer-section">
                <span class="drawer-title">ğŸ‘¨â€ğŸ’» é–‹ç™ºè€… (Creator)</span>
                <a href="#" target="_blank" class="creator-link" id="creatorLink">
                    <span style="font-size: 1.2rem;">ğŸ¦</span>
                    <span id="creatorName">@YourID</span>
                </a>
            </div>
            <div class="drawer-section">
                <span class="drawer-title">âœ¨ Special Thanks</span>
                <ul class="thanks-list" id="thanksList">
                    <!-- JSã§ç”Ÿæˆ -->
                </ul>
            </div>
        </div>

        <!-- ãƒˆã‚°ãƒ«ãƒœã‚¿ãƒ³ -->
        <div class="drawer-toggle" id="drawerToggle" title="Info & Credits">
            â„¹ï¸
        </div>
    </div>

    <!-- ãƒ¢ãƒ¼ãƒ€ãƒ«ã‚¦ã‚£ãƒ³ãƒ‰ã‚¦ (ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼ & åˆ©ç”¨è¦ç´„) -->
    <div id="infoModal" class="modal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <div class="modal-body" id="modalBody">
                <!-- JSã§å†…å®¹ã‚’æŒ¿å…¥ -->
            </div>
        </div>
    </div>

    <script>
        // =========================================
        // âš™ï¸ ã‚¢ãƒ—ãƒªè¨­å®šãƒ»ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆ (ç·¨é›†ã‚¨ãƒªã‚¢)
        // =========================================
        const CREDIT_INFO = {
            // åˆ¶ä½œè€…ã®Twitter (X) URL
            twitterUrl: "https://x.com/Abyss_tabletalk",

            // åˆ¶ä½œè€…ã®è¡¨ç¤ºå (ã‚ªãƒ—ã‚·ãƒ§ãƒ³)
            creatorName: "@Abyss_tabletalk",

            // ã‚¹ãƒšã‚·ãƒ£ãƒ«ã‚µãƒ³ã‚¯ã‚¹ (ãŠåå‰ãƒªã‚¹ãƒˆ)
            specialThanks: [
                "å¹³å’Œæ‹…å½“ã‚¬ãƒ³ãƒ‡ã‚£ãƒ¼",
                "é­”å¥³ ",
                "Keny",
                "ã‚ã„ã™",
                "é¯µ",
                "ãƒŠãƒ¦ã‚¿",
                "ã‚‹ãƒ¼ã‘ãƒ¼",
                "ã¿ã†ã¿ã†",
                "HAL",
                "ã‚‚ã™ã‘",
                "ã²ã ã‚Šã¡ã‚ƒã‚“",
                "ã¡ã‚€ã©ã‚“",
                "ã¯ã‚‹ã—ã‚…",
            ]
        };

        // åŸºæœ¬è¨­å®š
        const labels = ["é«˜ã•", "ã‚¯ãƒªã‚¢ã•", "ãƒ‘ãƒ¯ãƒ¼", "è‰¶", "æŸ”ã‚‰ã‹ã•", "éŸ¿ã"];
        const numPoints = 6;
        const centerX = 200;
        const centerY = 200;
        const maxRadius = 135;

        // DOMè¦ç´ 
        const realtimeMode = document.getElementById('realtimeMode');
        const precisionMode = document.getElementById('precisionMode');
        const canvas = document.getElementById('radarChart');
        const ctx = canvas.getContext('2d');
        const canvasPrecision = document.getElementById('radarChartPrecision');
        const ctxPrecision = canvasPrecision.getContext('2d');

        // =========================================
        // ğŸ“œ ãƒ¢ãƒ¼ãƒ€ãƒ« & ãƒ‰ãƒ­ãƒ¯ãƒ¼æ©Ÿèƒ½
        // =========================================

        // 1. ã‚¯ãƒ¬ã‚¸ãƒƒãƒˆæƒ…å ±ã®åæ˜ 
        document.addEventListener('DOMContentLoaded', () => {
            // Twitterãƒªãƒ³ã‚¯è¨­å®š
            const linkEl = document.getElementById('creatorLink');
            linkEl.href = CREDIT_INFO.twitterUrl;
            document.getElementById('creatorName').innerText = CREDIT_INFO.creatorName;

            // Thanksãƒªã‚¹ãƒˆç”Ÿæˆ
            const listEl = document.getElementById('thanksList');
            CREDIT_INFO.specialThanks.forEach(name => {
                const li = document.createElement('li');
                li.className = 'thanks-item';
                li.innerText = name;
                listEl.appendChild(li);
            });
        });

        // 2. ãƒ‰ãƒ­ãƒ¯ãƒ¼ã®é–‹é–‰
        const drawerToggle = document.getElementById('drawerToggle');
        const drawerContent = document.getElementById('drawerContent');

        drawerToggle.addEventListener('click', (e) => {
            e.stopPropagation();
            drawerContent.classList.toggle('active');
            // ã‚¢ã‚¤ã‚³ãƒ³åˆ‡ã‚Šæ›¿ãˆ
            if (drawerContent.classList.contains('active')) {
                drawerToggle.innerText = 'Ã—';
            } else {
                drawerToggle.innerText = 'â„¹ï¸';
            }
        });

        // ç”»é¢å¤–ã‚¯ãƒªãƒƒã‚¯ã§é–‰ã˜ã‚‹
        document.addEventListener('click', (e) => {
            if (!drawerContent.contains(e.target) && !drawerToggle.contains(e.target)) {
                drawerContent.classList.remove('active');
                drawerToggle.innerText = 'â„¹ï¸';
            }
        });

        // 3. ãƒ¢ãƒ¼ãƒ€ãƒ«æ©Ÿèƒ½ (ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼)
        const modal = document.getElementById('infoModal');
        const modalBody = document.getElementById('modalBody');
        const closeBtn = document.querySelector('.close-modal');
        const privacyBtn = document.getElementById('openPrivacy');
        const termsBtn = document.getElementById('openTerms');

        // ã‚³ãƒ³ãƒ†ãƒ³ãƒ„å®šç¾©
        const PRIVACY_CONTENT = `
            <h2>ğŸ”’ ãƒ—ãƒ©ã‚¤ãƒã‚·ãƒ¼ãƒãƒªã‚·ãƒ¼</h2>
            <h3>1. éŸ³å£°ãƒ‡ãƒ¼ã‚¿ã®å–ã‚Šæ‰±ã„ã«ã¤ã„ã¦</h3>
            <p>æœ¬ã‚¢ãƒ—ãƒªã€Œå£°è‰²ã‚¹ã‚³ãƒ¼ãƒ—ã€ã¯ã€ãƒã‚¤ã‚¯ã‹ã‚‰å…¥åŠ›ã•ã‚ŒãŸéŸ³å£°ãƒ‡ãƒ¼ã‚¿ã‚’ã€<strong>ãŠå®¢æ§˜ã®ç«¯æœ«ï¼ˆãƒ–ãƒ©ã‚¦ã‚¶ï¼‰å†…ã§ã®ã¿</strong>ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã«å‡¦ç†ãƒ»è§£æã—ã¦ã„ã¾ã™ã€‚</p>
            <p><strong>è§£æã•ã‚ŒãŸéŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒã€ã‚µãƒ¼ãƒãƒ¼ã¸é€ä¿¡ã•ã‚ŒãŸã‚Šã€ç¬¬ä¸‰è€…ã«æä¾›ã•ã‚ŒãŸã‚Šã™ã‚‹ã“ã¨ã¯ä¸€åˆ‡ã‚ã‚Šã¾ã›ã‚“ã€‚</strong></p>
            
            <h3>2. åºƒå‘Šé…ä¿¡ã«ã¤ã„ã¦</h3>
            <p>å½“ã‚µã‚¤ãƒˆã§ã¯ã€ç¬¬ä¸‰è€…é…ä¿¡ã®åºƒå‘Šã‚µãƒ¼ãƒ“ã‚¹ï¼ˆGoogle AdSenseç­‰ï¼‰ã‚’åˆ©ç”¨ã™ã‚‹äºˆå®šã§ã™ã€‚</p>
            <p>åºƒå‘Šé…ä¿¡äº‹æ¥­è€…ã¯ã€ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®èˆˆå‘³ã«å¿œã˜ãŸå•†å“ã‚„ã‚µãƒ¼ãƒ“ã‚¹ã®åºƒå‘Šã‚’è¡¨ç¤ºã™ã‚‹ãŸã‚ã€å½“ã‚µã‚¤ãƒˆã‚„ä»–ã‚µã‚¤ãƒˆã¸ã®ã‚¢ã‚¯ã‚»ã‚¹ã«é–¢ã™ã‚‹æƒ…å ±ã€ŒCookieã€(æ°åã€ä½æ‰€ã€ãƒ¡ãƒ¼ãƒ« ã‚¢ãƒ‰ãƒ¬ã‚¹ã€é›»è©±ç•ªå·ã¯å«ã¾ã‚Œã¾ã›ã‚“) ã‚’ä½¿ç”¨ã™ã‚‹ã“ã¨ãŒã‚ã‚Šã¾ã™ã€‚</p>
            
            <h3>3. è§£æçµæœã«ã¤ã„ã¦</h3>
            <p>æœ¬ã‚¢ãƒ—ãƒªã«ã‚ˆã‚‹è§£æçµæœï¼ˆå£°ã®è‰²ã€éŸ³åŸŸæ¸¬å®šãªã©ï¼‰ã¯ã€ç‹¬è‡ªã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«åŸºã¥ãã‚¨ãƒ³ã‚¿ãƒ¼ãƒ†ã‚¤ãƒ³ãƒ¡ãƒ³ãƒˆç›®çš„ã®ã‚‚ã®ã§ã™ã€‚åŒ»å­¦çš„ãƒ»ç§‘å­¦çš„ãªæ­£ç¢ºæ€§ã‚’ä¿è¨¼ã™ã‚‹ã‚‚ã®ã§ã¯ã‚ã‚Šã¾ã›ã‚“ã€‚</p>
        `;

        const TERMS_CONTENT = `
            <h2>ğŸ“ åˆ©ç”¨è¦ç´„</h2>
            <h3>1. å…è²¬äº‹é …</h3>
            <p>æœ¬ã‚¢ãƒ—ãƒªã®åˆ©ç”¨ã«ã‚ˆã‚Šç”Ÿã˜ãŸã„ã‹ãªã‚‹æå®³ã«ã¤ã„ã¦ã‚‚ã€é–‹ç™ºè€…ã¯ä¸€åˆ‡ã®è²¬ä»»ã‚’è² ã„ã¾ã›ã‚“ã€‚</p>
            <p>éŸ³åŸŸæ¸¬å®šã®çµæœãªã©ã®æ­£ç¢ºæ€§ã«ã¤ã„ã¦ã¯ä¿è¨¼ã„ãŸã—ã‹ã­ã¾ã™ã€‚ã‚ãã¾ã§ç›®å®‰ãƒ»ãŠæ¥½ã—ã¿ã¨ã—ã¦ã”åˆ©ç”¨ãã ã•ã„ã€‚</p>
            
            <h3>2. è‘—ä½œæ¨©</h3>
            <p>æœ¬ã‚¢ãƒ—ãƒªã®ãƒ—ãƒ­ã‚°ãƒ©ãƒ ã‚³ãƒ¼ãƒ‰ã€ãƒ‡ã‚¶ã‚¤ãƒ³ã€ç‹¬è‡ªã®ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ã«é–¢ã™ã‚‹æ¨©åˆ©ã¯é–‹ç™ºè€…ã«å¸°å±ã—ã¾ã™ã€‚</p>
        `;

        function openModal(content) {
            modalBody.innerHTML = content;
            modal.style.display = "block";
            // ã‚¹ã‚¯ãƒ­ãƒ¼ãƒ«ç¦æ­¢
            document.body.style.overflow = "hidden";
        }

        function closeModal() {
            modal.style.display = "none";
            document.body.style.overflow = "auto";
        }

        privacyBtn.addEventListener('click', () => openModal(PRIVACY_CONTENT));
        termsBtn.addEventListener('click', () => openModal(TERMS_CONTENT));
        closeBtn.addEventListener('click', closeModal);
        window.addEventListener('click', (e) => {
            if (e.target == modal) closeModal();
        });


        // ========================================
        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¢ãƒ¼ãƒ‰ - ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        let audioStream = null;                  // ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ ï¼ˆå†åˆ©ç”¨ï¼‰
        let audioContext = null;                 // Web Audio APIã‚³ãƒ³ãƒ†ã‚­ã‚¹ãƒˆ
        let analyser = null;                     // å‘¨æ³¢æ•°è§£æå™¨
        let isAnalyzing = false;                 // åˆ†æä¸­ãƒ•ãƒ©ã‚°
        let animationId = null;                  // ã‚¢ãƒ‹ãƒ¡ãƒ¼ã‚·ãƒ§ãƒ³ãƒ•ãƒ¬ãƒ¼ãƒ ID

        // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°è¨­å®š
        let previousValues = [0.5, 0.5, 0.5, 0.5, 0.5, 0.5];  // å‰å›ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿å€¤ï¼ˆ6é …ç›®ï¼‰
        const smoothingFactor = 0.45;            // ã‚¹ãƒ ãƒ¼ã‚¸ãƒ³ã‚°å¼·åº¦ï¼ˆ0.45 = ã¨ã¦ã‚‚æ»‘ã‚‰ã‹ï¼‰
        const noiseGateThreshold = 0.05;         // ãƒã‚¤ã‚ºã‚²ãƒ¼ãƒˆé–¾å€¤ï¼ˆå°ã•ã„éŸ³ã‚’ç„¡è¦–ï¼‰

        // ãƒ”ãƒƒãƒç§»å‹•å¹³å‡ç”¨ï¼ˆä¸€ç¬ã®é«˜éŸ³ãƒã‚¤ã‚ºã‚’é™¤å»ã™ã‚‹ãŸã‚ã®è¨­å®šï¼‰
        let pitchHistory = [];                   // ãƒ”ãƒƒãƒå±¥æ­´é…åˆ—
        const pitchHistorySize = 10;             // éå»10ãƒ•ãƒ¬ãƒ¼ãƒ ã®å¹³å‡ã‚’å–ã‚‹
        // â€» å¤§ããã™ã‚‹ã¨æ»‘ã‚‰ã‹ã ãŒåå¿œãŒé…ããªã‚‹ï¼ˆ15-20æ¨å¥¨ï¼‰

        // ========================================
        // ç²¾å¯†åˆ†æãƒ¢ãƒ¼ãƒ‰ - ã‚°ãƒ­ãƒ¼ãƒãƒ«å¤‰æ•°
        // ========================================
        let isRecording = false;                 // éŒ²éŸ³ä¸­ãƒ•ãƒ©ã‚°
        let recordingData = [];                  // éŒ²éŸ³ãƒ‡ãƒ¼ã‚¿ï¼ˆãƒ•ãƒ¬ãƒ¼ãƒ ã”ã¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ï¼‰
        let recordingStartTime = 0;              // éŒ²éŸ³é–‹å§‹æ™‚åˆ»
        const recordingDuration = 30000;         // éŒ²éŸ³æ™‚é–“ï¼ˆ30ç§’ï¼‰

        // ãƒ¢ãƒ¼ãƒ‰åˆ‡æ›¿
        document.querySelectorAll('.mode-tab').forEach(tab => {
            tab.addEventListener('click', () => {
                const mode = tab.dataset.mode;
                document.querySelectorAll('.mode-tab').forEach(t => t.classList.remove('active'));
                tab.classList.add('active');

                if (mode === 'realtime') {
                    realtimeMode.classList.add('active');
                    precisionMode.classList.remove('active');
                    if (isRecording) stopRecording();
                } else {
                    realtimeMode.classList.remove('active');
                    precisionMode.classList.add('active');
                    if (isAnalyzing) stopAnalysis();
                    drawBasePrecision();
                }
            });
        });

        // ãƒã‚¤ã‚¯ã‚¹ãƒˆãƒªãƒ¼ãƒ å–å¾—
        async function getMicStream() {
            if (!audioStream) {
                audioStream = await navigator.mediaDevices.getUserMedia({ audio: true });
            }
            return audioStream;
        }

        // è‰²è¨ˆç®—ï¼ˆä½éŸ³=å¯’è‰²ã€é«˜éŸ³=æš–è‰²ï¼‰
        function calculateVoiceColor(values) {
            const heightValue = values[0];
            let baseHue = 240 - (heightValue * 240); // 240åº¦(é’)â†’0åº¦(èµ¤)

            const clearAdjust = (values[1] - 0.5) * 30;
            let finalHue = baseHue + clearAdjust;
            if (finalHue < 0) finalHue += 360;
            if (finalHue >= 360) finalHue -= 360;

            const powerGloss = (values[2] + values[3]) / 2;
            const saturation = Math.round(70 + powerGloss * 30);

            const softnessResonance = (values[4] + values[5]) / 2;
            const lightness = Math.round(55 + softnessResonance * 20);

            return {
                hue: Math.round(finalHue),
                saturation,
                lightness
            };
        }

        // HSL to HEX
        function hslToHex(h, s, l) {
            s /= 100;
            l /= 100;
            const c = (1 - Math.abs(2 * l - 1)) * s;
            const x = c * (1 - Math.abs((h / 60) % 2 - 1));
            const m = l - c / 2;
            let r = 0, g = 0, b = 0;

            if (0 <= h && h < 60) { r = c; g = x; b = 0; }
            else if (60 <= h && h < 120) { r = x; g = c; b = 0; }
            else if (120 <= h && h < 180) { r = 0; g = c; b = x; }
            else if (180 <= h && h < 240) { r = 0; g = x; b = c; }
            else if (240 <= h && h < 300) { r = x; g = 0; b = c; }
            else { r = c; g = 0; b = x; }

            const toHex = (num) => {
                const hex = Math.round((num + m) * 255).toString(16);
                return hex.length === 1 ? '0' + hex : hex;
            };
            return `#${toHex(r)}${toHex(g)}${toHex(b)}`.toUpperCase();
        }

        // ===== æœ¬æ ¼çš„ãªéŸ³å£°åˆ†æé–¢æ•° =====

        // Spectral Centroidï¼ˆã‚¹ãƒšã‚¯ãƒˆãƒ«é‡å¿ƒï¼‰- ã‚¯ãƒªã‚¢ã•ã®æŒ‡æ¨™
        function calculateSpectralCentroid(freqData) {
            let weightedSum = 0;
            let totalSum = 0;
            for (let i = 0; i < freqData.length; i++) {
                weightedSum += freqData[i] * i;
                totalSum += freqData[i];
            }
            return totalSum > 0 ? weightedSum / totalSum : 0;
        }

        // Spectral Rolloffï¼ˆã‚¹ãƒšã‚¯ãƒˆãƒ«ãƒ­ãƒ¼ãƒ«ã‚ªãƒ•ï¼‰- è‰¶ã®æŒ‡æ¨™
        function calculateSpectralRolloff(freqData, threshold = 0.85) {
            let totalEnergy = 0;
            for (let i = 0; i < freqData.length; i++) {
                totalEnergy += freqData[i];
            }

            let cumulativeEnergy = 0;
            const targetEnergy = totalEnergy * threshold;

            for (let i = 0; i < freqData.length; i++) {
                cumulativeEnergy += freqData[i];
                if (cumulativeEnergy >= targetEnergy) {
                    return i / freqData.length;
                }
            }
            return 1.0;
        }

        // RMS Energyï¼ˆå®ŸåŠ¹å€¤ã‚¨ãƒãƒ«ã‚®ãƒ¼ï¼‰- ãƒ‘ãƒ¯ãƒ¼ã®æŒ‡æ¨™
        function calculateRMSEnergy(freqData) {
            let sum = 0;
            for (let i = 0; i < freqData.length; i++) {
                sum += freqData[i] * freqData[i];
            }
            return Math.sqrt(sum / freqData.length);
        }

        // Spectral Flatnessï¼ˆã‚¹ãƒšã‚¯ãƒˆãƒ«å¹³å¦åº¦ï¼‰- æŸ”ã‚‰ã‹ã•ã®æŒ‡æ¨™
        function calculateSpectralFlatness(freqData) {
            let geometricMean = 1;
            let arithmeticMean = 0;
            let validCount = 0;

            for (let i = 1; i < freqData.length; i++) {
                if (freqData[i] > 0) {
                    geometricMean *= Math.pow(freqData[i], 1 / freqData.length);
                    arithmeticMean += freqData[i];
                    validCount++;
                }
            }

            if (validCount === 0) return 0;
            arithmeticMean /= validCount;

            return arithmeticMean > 0 ? geometricMean / arithmeticMean : 0;
        }

        // å£°ã®6ã¤ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’æœ¬æ ¼çš„ã«åˆ†æ
        function analyzeVoiceFeatures(freqData) {
            const centroid = calculateSpectralCentroid(freqData);
            const rolloff = calculateSpectralRolloff(freqData);
            const rmsEnergy = calculateRMSEnergy(freqData);
            const flatness = calculateSpectralFlatness(freqData);

            // 1. é«˜ã• (Height/Pitch)
            // äººé–“ã®å£°åŸŸã«æœ€é©åŒ–ã—ãŸç¯„å›²ï¼ˆbin 1-30ï¼‰ã§æœ€ã‚‚å¼·ã„æˆåˆ†ã‚’æ¤œå‡º
            let maxLowFreqIndex = 0;
            let maxLowFreqValue = 0;
            for (let i = 1; i < 30; i++) {
                if (freqData[i] > maxLowFreqValue) {
                    maxLowFreqValue = freqData[i];
                    maxLowFreqIndex = i;
                }
            }
            // æ­£è¦åŒ–: ã‚ˆã‚Šå‹•çš„ã«èª¿æ•´
            // bin 1-3 (ç”·æ€§) â†’ 0.0-0.2
            // bin 6-10 (ä¸­æ€§) â†’ 0.4-0.6  
            // bin 12-20 (å¥³æ€§) â†’ 0.7-0.9
            // bin 20+ (é«˜ã„å£°) â†’ 0.9-1.0
            const height = Math.min(1.0, Math.max(0.0, (maxLowFreqIndex - 1) / 25));

            // 2. ã‚¯ãƒªã‚¢ã• (Clarity) - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”¨ï¼ˆåºƒã‚ã®ç¯„å›²ï¼‰
            // å¤§å¹…æ”¹å–„: åˆ†æ¯ã‚’40â†’25ã«ç¸®å°ã—ã¦æ„Ÿåº¦ã‚’ã•ã‚‰ã«1.6å€å‘ä¸Šï¼ˆç´¯ç©2.8å€ï¼‰
            // èª¿æ•´å€¤: -0.10ï¼ˆæ„Ÿåº¦å‘ä¸Šã«åˆã‚ã›ã¦å†èª¿æ•´ï¼‰
            const clarity = Math.min(1.0, Math.max(0.0, (centroid - 10) / 25 - 0.10));

            // 3. ãƒ‘ãƒ¯ãƒ¼ (Power) - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”¨ï¼ˆç·©ã‚ï¼‰
            // å®Ÿæ¸¬èª¿æ•´: -0.10 é©ç”¨ï¼ˆå³ã—ã™ãã‚‹ãŸã‚ç·©å’Œï¼‰
            const power = Math.min(1.0, Math.max(0.0, rmsEnergy / 100 - 0.10));

            // 4. è‰¶ (Brightness/Gloss) - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”¨ï¼ˆç·©ã‚ï¼‰
            // å¤§å¹…æ”¹å–„: åˆ†æ¯ã‚’35â†’20ã«ç¸®å°ã—ã¦æ„Ÿåº¦ã‚’ã•ã‚‰ã«1.75å€å‘ä¸Šï¼ˆç´¯ç©3å€ï¼‰
            // èª¿æ•´å€¤: -0.08ï¼ˆæ„Ÿåº¦å‘ä¸Šã«åˆã‚ã›ã¦å†èª¿æ•´ï¼‰
            const gloss = Math.min(1.0, Math.max(0.0, (centroid - 15) / 20 - 0.08));

            // 5. æŸ”ã‚‰ã‹ã• (Softness)
            // Spectral Flatnessã‚’æ´»ç”¨ï¼ˆåºƒã„ç¯„å›²ã«å¯¾å¿œï¼‰
            // flatnessãŒé«˜ã„ï¼ˆãƒã‚¤ã‚ºçš„ï¼‰ = æŸ”ã‚‰ã‹ããªã„
            // flatnessãŒä½ã„ï¼ˆãƒˆãƒ¼ãƒ³çš„ï¼‰ = æŸ”ã‚‰ã‹ã„
            // 5. æŸ”ã‚‰ã‹ã• (Softness) - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”¨ï¼ˆç·©ã‚ï¼‰
            // å®Ÿæ¸¬èª¿æ•´: +0.15 é©ç”¨ï¼ˆå¤§å¹…ã«æŠ‘ãˆã‚‹ï¼‰
            let softness;
            if (rmsEnergy < 5) {
                softness = 0;
            } else {
                softness = Math.min(1.0, Math.max(0.0, (0.25 - flatness) / 0.3 + 0.15));
            }

            // 6. éŸ¿ã (Resonance)
            // ä¸­å‘¨æ³¢å¸¯åŸŸï¼ˆ20-60binï¼‰ã®ã‚¨ãƒãƒ«ã‚®ãƒ¼æ¯”ç‡
            let midFreqEnergy = 0;
            let totalEnergy = 0;
            for (let i = 0; i < freqData.length; i++) {
                totalEnergy += freqData[i];
                if (i >= 20 && i <= 60) {
                    midFreqEnergy += freqData[i];
                }
            }
            // 6. éŸ¿ã (Resonance) - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ç”¨ï¼ˆç·©ã‚ï¼‰
            // å®Ÿæ¸¬èª¿æ•´: -0.15 é©ç”¨ï¼ˆå³ã—ã™ãã‚‹ãŸã‚ç·©å’Œï¼‰
            let resonance;
            if (rmsEnergy < 5 || totalEnergy === 0) {
                resonance = 0;
            } else {
                const ratio = midFreqEnergy / totalEnergy;
                resonance = Math.min(1.0, Math.max(0.0, (ratio - 0.10) / 0.25 - 0.15));
            }

            return [height, clarity, power, gloss, softness, resonance];
        }

        // ========================================
        // ç²¾å¯†åˆ†æãƒ¢ãƒ¼ãƒ‰å°‚ç”¨ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è¨ˆç®—ï¼ˆFFT 2048å¯¾å¿œï¼‰
        // ========================================
        function analyzeVoiceFeaturesPrecision(freqData) {
            // FFTã‚µã‚¤ã‚ºã®é•ã„ï¼ˆ2048 vs 256 = 8å€ï¼‰ã‚’è£œæ­£
            // ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ãƒ™ãƒ¼ã‚¹ã®æŒ‡æ¨™ã‚’ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ãƒ¢ãƒ¼ãƒ‰ã®åŸºæº–ï¼ˆ256ï¼‰ã«åˆã‚ã›ã‚‹
            const centroid = calculateSpectralCentroid(freqData) / 8;
            const rmsEnergy = calculateRMSEnergy(freqData);
            const flatness = calculateSpectralFlatness(freqData);

            // æœ€å¤§å€¤ã‚¤ãƒ³ãƒ‡ãƒƒã‚¯ã‚¹ã‚’æ¤œå‡ºï¼ˆé«˜ã•ç”¨ï¼‰
            let maxLowFreqValue = 0;
            let maxLowFreqIndex = 0;
            // å‘¨æ³¢æ•°åˆ†è§£èƒ½ãŒé«˜ã„ã®ã§ã€æ¢ç´¢ç¯„å›²ã‚‚åºƒã’ã‚‹ï¼ˆ100 * 8 = 800ç›¸å½“ã§ã¯ãªã„ã€ç‰©ç†å‘¨æ³¢æ•°ã¯åŒã˜ï¼‰
            // RT: index 30 (5kHz) -> Precision: index 240 (5kHz)
            // ãŸã ã—é«˜ã•è¨ˆç®—ã¯å¾Œã§pitchã‹ã‚‰è¡Œã†ã®ã§ã€ã“ã“ã®å½±éŸ¿ã¯å°‘ãªã„ãŒå¿µã®ãŸã‚
            for (let i = 1; i <= 100; i++) {
                if (freqData[i] > maxLowFreqValue) {
                    maxLowFreqValue = freqData[i];
                    maxLowFreqIndex = i;
                }
            }

            // 1. é«˜ã• (Height)
            // indexã‚‚8ã§å‰²ã£ã¦æ­£è¦åŒ–
            const height = Math.min(1.0, Math.max(0.0, ((maxLowFreqIndex / 8) - 1) / 25));

            // 2. ã‚¯ãƒªã‚¢ã• (Clarity) - ç²¾å¯†åˆ†æãƒ¢ãƒ¼ãƒ‰å°‚ç”¨èª¿æ•´
            // å¹³å‡å€¤ãŒ60%å‰å¾Œã«ãªã‚‹ã‚ˆã†ã«ã€ãƒ—ãƒ©ã‚¹ã®è£œæ­£ã‚’åŠ ãˆã‚‹
            // å¹…ï¼ˆ25ï¼‰ã¯ç¶­æŒ
            // æ¨å®šCentroid 8-10 ã«å¯¾ã—ã€(9 + 5) / 25 = 0.56 (56%)
            const clarity = Math.min(1.0, Math.max(0.0, (centroid + 5) / 25));

            // 3. ãƒ‘ãƒ¯ãƒ¼ (Power) - ç²¾å¯†åˆ†æãƒ¢ãƒ¼ãƒ‰å°‚ç”¨èª¿æ•´
            // å¹³å‡åŒ–ã§ä½ãå‡ºã‚‹ãŸã‚ã€è£œæ­£å€¤ã‚’åŠ ãˆã‚‹ï¼ˆ+0.20ï¼‰
            const power = Math.min(1.0, Math.max(0.0, rmsEnergy / 100 + 0.20));

            // 4. è¼ã/è‰¶ (Gloss) - ç²¾å¯†åˆ†æãƒ¢ãƒ¼ãƒ‰å°‚ç”¨èª¿æ•´
            // å¹³å‡å€¤ãŒ60%å‰å¾Œã«ãªã‚‹ã‚ˆã†ã«ã€ãƒ—ãƒ©ã‚¹ã®è£œæ­£ã‚’åŠ ãˆã‚‹
            // å¹…ï¼ˆ20ï¼‰ã¯ç¶­æŒ
            // æ¨å®šCentroid 8-10 ã«å¯¾ã—ã€(9 + 2) / 20 = 0.55 (55%)
            const gloss = Math.min(1.0, Math.max(0.0, (centroid + 2) / 20));

            // 5. æŸ”ã‚‰ã‹ã• (Softness) - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã¨åŒã˜
            let softness;
            if (rmsEnergy < 5) {
                softness = 0;
            } else {
                softness = Math.min(1.0, Math.max(0.0, (0.25 - flatness) / 0.3 + 0.15));
            }

            // 6. éŸ¿ã (Resonance) - ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ ã¨åŒã˜
            let midFreqEnergy = 0;
            let totalEnergy = 0;
            for (let i = 0; i < freqData.length; i++) {
                totalEnergy += freqData[i];
                if (i >= 20 && i <= 60) {
                    midFreqEnergy += freqData[i];
                }
            }
            let resonance;
            if (rmsEnergy < 5 || totalEnergy === 0) {
                resonance = 0;
            } else {
                const ratio = midFreqEnergy / totalEnergy;
                resonance = Math.min(1.0, Math.max(0.0, (ratio - 0.10) / 0.25 - 0.15));
            }

            return [height, clarity, power, gloss, softness, resonance];
        }

        // åŸºæœ¬ã‚°ãƒ©ãƒ•æç”»
        function drawBase(context) {
            context.clearRect(0, 0, 400, 400);
            context.strokeStyle = "#eee";
            context.lineWidth = 1;

            for (let i = 1; i <= 4; i++) {
                context.beginPath();
                const r = (maxRadius / 4) * i;
                for (let j = 0; j < numPoints; j++) {
                    const angle = (Math.PI * 2 / numPoints) * j - Math.PI / 2;
                    const x = centerX + r * Math.cos(angle);
                    const y = centerY + r * Math.sin(angle);
                    if (j === 0) context.moveTo(x, y);
                    else context.lineTo(x, y);
                }
                context.closePath();
                context.stroke();
            }

            context.fillStyle = "#aaa";
            context.font = "20px sans-serif";
            context.textAlign = "center";
            for (let i = 0; i < numPoints; i++) {
                const angle = (Math.PI * 2 / numPoints) * i - Math.PI / 2;
                const x = centerX + (maxRadius + 35) * Math.cos(angle);
                const y = centerY + (maxRadius + 35) * Math.sin(angle);
                context.fillText(labels[i], x, y + 8);
            }
        }

        function drawBasePrecision() {
            drawBase(ctxPrecision);
        }

        // ãƒªã‚¢ãƒ«ã‚¿ã‚¤ãƒ åˆ†æé–‹å§‹
        document.getElementById('startBtn').addEventListener('click', async () => {
            if (isAnalyzing) {
                stopAnalysis();
            } else {
                try {
                    const stream = await getMicStream();
                    audioContext = new (window.AudioContext || window.webkitAudioContext)();
                    const source = audioContext.createMediaStreamSource(stream);
                    analyser = audioContext.createAnalyser();
                    analyser.fftSize = 256;
                    source.connect(analyser);

                    isAnalyzing = true;
                    document.getElementById('startBtn').innerText = 'åˆ†æã‚’åœæ­¢ã™ã‚‹';
                    document.getElementById('voiceColorRealtime').classList.add('active');
                    updateRealtime();
                } catch (err) {
                    document.getElementById('statusRealtime').innerText = 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ';
                }
            }
        });

        function stopAnalysis() {
            isAnalyzing = false;
            if (animationId) cancelAnimationFrame(animationId);
            if (audioContext) audioContext.close();
            document.getElementById('startBtn').innerText = 'åˆ†æã‚’é–‹å§‹ã™ã‚‹';
            document.getElementById('voiceColorRealtime').classList.remove('active');
            drawBase(ctx);
        }

        function updateRealtime() {
            if (!isAnalyzing) return;

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            // æœ¬æ ¼çš„ãªéŸ³å£°åˆ†æã‚’å®Ÿæ–½
            const rawValues = analyzeVoiceFeatures(dataArray);

            const avgVolume = dataArray.reduce((a, b) => a + b) / dataArray.length / 255;
            let values;
            if (avgVolume < noiseGateThreshold) {
                // éŸ³å£°ãŒãªã„å ´åˆã¯åŸºæœ¬ã‚°ãƒ©ãƒ•ã®ã¿è¡¨ç¤º
                drawBase(ctx);
                animationId = requestAnimationFrame(updateRealtime);
                return;
            } else {
                values = rawValues.map((val, i) => previousValues[i] + (val - previousValues[i]) * smoothingFactor);
                previousValues = [...values];

                // ç²¾å¯†åˆ†æãƒ¢ãƒ¼ãƒ‰ã¨åŒã˜æ–¹æ³•ã§ãƒ”ãƒƒãƒã‚’æ¤œå‡ºã—ã¦é«˜ã•ã‚’è¨ˆç®—
                // FFTçµæœã‹ã‚‰æœ€ã‚‚å¼·ã„ãƒ”ãƒ¼ã‚¯ã‚’è¦‹ã¤ã‘ã‚‹
                // å€éŸ³ã‚’å›é¿ã™ã‚‹ãŸã‚ã€ä½ã„binã‚’å„ªå…ˆ
                let maxIndex = 0;
                let maxValue = 0;

                // ã¾ãšä½éŸ³åŸŸï¼ˆbin 1-20ï¼‰ã§å¼·ã„ãƒ”ãƒ¼ã‚¯ã‚’æ¢ã™
                for (let i = 1; i < 20; i++) {
                    if (dataArray[i] > maxValue && dataArray[i] > 30) {  // é–‰å€¤ã‚’è¨­ã‘ã‚‹
                        maxValue = dataArray[i];
                        maxIndex = i;
                    }
                }

                // ä½éŸ³åŸŸã«ååˆ†ãªãƒ”ãƒ¼ã‚¯ãŒãªã‘ã‚Œã°ã€å…¨ç¯„å›²ã‚’æ¢ã™
                if (maxValue < 30) {
                    maxIndex = 0;
                    maxValue = 0;
                    for (let i = 1; i < 100; i++) {
                        if (dataArray[i] > maxValue) {
                            maxValue = dataArray[i];
                            maxIndex = i;
                        }
                    }
                }

                // ========================================
                // ãƒ”ãƒƒãƒæ¤œå‡ºï¼ˆå€éŸ³å¯¾ç­– + ç§»å‹•å¹³å‡ï¼‰
                // ========================================

                // ãƒ”ãƒƒãƒã‚’è¨ˆç®—
                const sampleRate = audioContext.sampleRate || 44100;
                const binSize = sampleRate / analyser.fftSize;
                const pitch = maxIndex * binSize;


                // ãƒ”ãƒƒãƒãŒæœ‰åŠ¹ç¯„å›²å†…ï¼ˆ80-600Hzï¼‰ãªã‚‰ã€ç§»å‹•å¹³å‡ã‚’è¨ˆç®—
                if (pitch >= 80 && pitch <= 600) {
                    // ãƒ”ãƒƒãƒå±¥æ­´ã«è¿½åŠ 
                    pitchHistory.push(pitch);

                    // å±¥æ­´ã‚µã‚¤ã‚ºã‚’è¶…ãˆãŸã‚‰å¤ã„ã‚‚ã®ã‚’å‰Šé™¤ï¼ˆFIFOï¼‰
                    if (pitchHistory.length > pitchHistorySize) {
                        pitchHistory.shift();
                    }

                    // ã€é‡è¦ã€‘ç§»å‹•å¹³å‡ã‚’è¨ˆç®—ï¼ˆéå»10ãƒ•ãƒ¬ãƒ¼ãƒ ã®å¹³å‡ï¼‰
                    // ã“ã‚Œã«ã‚ˆã‚Šä¸€ç¬ã®é«˜éŸ³ãƒã‚¤ã‚ºãŒé™¤å»ã•ã‚Œã€é€£ç¶šã—ãŸéŸ³ã®å¹³å‡çš„ãªé«˜ã•ã‚’æ¤œå‡º
                    // â†’ ä½ã„å£°ã®äººã¯å¸¸ã«ä½ãã€é«˜ã„å£°ã®äººã¯å¸¸ã«é«˜ãè¡¨ç¤ºã•ã‚Œã‚‹
                    const avgPitch = pitchHistory.reduce((sum, p) => sum + p, 0) / pitchHistory.length;

                    // å¹³å‡ãƒ”ãƒƒãƒã‹ã‚‰é«˜ã•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’è¨ˆç®—
                    // ç¯„å›²: 80-600Hzï¼ˆåºƒç¯„å›²ã§ç”·å¥³ä¸¡æ–¹ã‚’ã‚«ãƒãƒ¼ï¼‰
                    // ç”·æ€§ä½éŸ³80Hzâ†’0.0, è¶…é«˜éŸ³å¥³æ€§600Hzâ†’1.0
                    const pitchBasedHeight = Math.min(1.0, Math.max(0.0, (avgPitch - 80) / 520));
                    values[0] = pitchBasedHeight;
                }
            }

            const voiceColor = calculateVoiceColor(values);
            const hsl = `hsl(${voiceColor.hue}, ${voiceColor.saturation}%, ${voiceColor.lightness}%)`;
            const hex = hslToHex(voiceColor.hue, voiceColor.saturation, voiceColor.lightness);

            drawBase(ctx);
            ctx.beginPath();
            const grad = ctx.createRadialGradient(centerX, centerY, 0, centerX, centerY, maxRadius);
            grad.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
            grad.addColorStop(1, `hsla(${voiceColor.hue}, ${voiceColor.saturation}%, ${Math.min(80, voiceColor.lightness + 10)}%, 0.6)`);
            ctx.fillStyle = grad;
            ctx.strokeStyle = `hsl(${voiceColor.hue}, ${voiceColor.saturation}%, ${Math.max(35, voiceColor.lightness - 15)}%)`;
            ctx.lineWidth = 3;

            for (let i = 0; i < numPoints; i++) {
                const angle = (Math.PI * 2 / numPoints) * i - Math.PI / 2;
                const val = Math.max(0.2, values[i]);
                const x = centerX + (maxRadius * val) * Math.cos(angle);
                const y = centerY + (maxRadius * val) * Math.sin(angle);
                if (i === 0) ctx.moveTo(x, y);
                else ctx.lineTo(x, y);
            }
            ctx.closePath();
            ctx.fill();
            ctx.stroke();

            document.getElementById('colorDisplayRealtime').style.backgroundColor = hsl;
            document.getElementById('colorValueRealtime').innerText = `è‰²ç›¸:${voiceColor.hue}Â° å½©åº¦:${voiceColor.saturation}% æ˜åº¦:${voiceColor.lightness}%`;
            document.getElementById('colorHexRealtime').innerText = hex;

            animationId = requestAnimationFrame(updateRealtime);
        }

        // ç²¾å¯†åˆ†æé–‹å§‹
        document.getElementById('recordBtn').addEventListener('click', async () => {
            if (isRecording) return;

            try {
                const stream = await getMicStream();
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
                const source = audioContext.createMediaStreamSource(stream);
                analyser = audioContext.createAnalyser();
                analyser.fftSize = 2048;  // 256 â†’ 2048 ã«å¤‰æ›´ï¼ˆå‘¨æ³¢æ•°åˆ†è§£èƒ½å‘ä¸Šï¼‰
                source.connect(analyser);

                // ãƒ‡ãƒãƒƒã‚°æƒ…å ±
                const binSize = audioContext.sampleRate / analyser.fftSize;
                console.log('===== éŒ²éŸ³é–‹å§‹ =====');
                console.log('Sample Rate:', audioContext.sampleRate, 'Hz');
                console.log('FFT Size:', analyser.fftSize);
                console.log('Bin Size:', binSize.toFixed(2), 'Hz');
                console.log('bin 3 =', (3 * binSize).toFixed(1), 'Hz (æ­£ã—ãã¯64.5Hzä»˜è¿‘)');

                isRecording = true;
                recordingData = [];
                recordingStartTime = Date.now();

                document.getElementById('recordBtn').disabled = true;
                document.getElementById('recordingProgress').classList.add('active');
                document.getElementById('recordingGuide').classList.add('active');
                document.getElementById('recordingIndicator').style.display = 'block';
                document.getElementById('precisionResult').classList.remove('active');

                collectData();
            } catch (err) {
                document.getElementById('statusPrecision').innerText = 'ãƒã‚¤ã‚¯ã‚¢ã‚¯ã‚»ã‚¹ãŒæ‹’å¦ã•ã‚Œã¾ã—ãŸ';
            }
        });

        function collectData() {
            if (!isRecording) return;

            const elapsed = Date.now() - recordingStartTime;
            document.getElementById('progressBar').style.width = Math.min(100, (elapsed / recordingDuration) * 100) + '%';

            if (elapsed >= recordingDuration) {
                finishRecording();
                return;
            }

            const dataArray = new Uint8Array(analyser.frequencyBinCount);
            analyser.getByteFrequencyData(dataArray);

            // ç²¾å¯†åˆ†æãƒ¢ãƒ¼ãƒ‰ç”¨ã®ç‰¹åˆ¥ãªéŸ³å£°åˆ†æï¼ˆFFT 2048å¯¾å¿œï¼‰
            const values = analyzeVoiceFeaturesPrecision(dataArray);

            // éŸ³é‡ãƒã‚§ãƒƒã‚¯ï¼ˆã‚¤ãƒ³ã‚¸ã‚±ãƒ¼ã‚¿ãƒ¼æ›´æ–°ï¼‰
            const avgVolume = dataArray.reduce((a, b) => a + b) / dataArray.length;
            const volumePercent = Math.min(100, (avgVolume / 50) * 100);
            document.getElementById('volumeBar').style.width = volumePercent + '%';

            // ã‚ˆã‚Šç·©ã„ãƒã‚¤ã‚ºãƒ•ã‚£ãƒ«ã‚¿ï¼ˆéŸ³å£°æ¤œå‡ºã‚’ç¢ºå®Ÿã«ï¼‰
            if (avgVolume < 0.3) {
                setTimeout(collectData, 100);
                return;
            }

            // FFTçµæœã‹ã‚‰æœ€ã‚‚å¼·ã„ãƒ”ãƒ¼ã‚¯ã‚’è¦‹ã¤ã‘ã‚‹ï¼ˆã‚ˆã‚Šåºƒã„ç¯„å›²ï¼‰
            let maxIndex = 0;
            let maxValue = 0;
            // bin 1-2ã¯ä½ã™ãã‚‹ãƒã‚¤ã‚ºãªã®ã§é™¤å¤–ã€3ã‹ã‚‰é–‹å§‹
            for (let i = 3; i < 120; i++) {
                if (dataArray[i] > maxValue) {
                    maxValue = dataArray[i];
                    maxIndex = i;
                }
            }

            // ãƒ”ãƒ¼ã‚¯ãŒå°ã•ã™ãã‚‹å ´åˆã¯ã‚¹ã‚­ãƒƒãƒ—ï¼ˆé–¾å€¤ã‚’ä¸Šã’ã‚‹ï¼‰
            if (maxValue < 8) {
                setTimeout(collectData, 100);
                return;
            }

            //  å‘¨æ³¢æ•°è¨ˆç®—
            const sampleRate = audioContext.sampleRate || 44100;
            const binSize = sampleRate / analyser.fftSize;
            let pitch = maxIndex * binSize;

            // ãƒ‡ãƒãƒƒã‚°: ãƒ”ãƒƒãƒã‚’è¨˜éŒ²
            if (recordingData.length < 5 || recordingData.length % 50 === 0) {
                console.log(`ãƒ•ãƒ¬ãƒ¼ãƒ  ${recordingData.length}: bin ${maxIndex}, pitch ${pitch.toFixed(1)} Hz, value ${maxValue}`);
            }

            // äººé–“ã®å£°åŸŸï¼ˆ80Hz-600Hzï¼‰
            // 600Hzä»¥ä¸Šã¯å€éŸ³ã®å¯èƒ½æ€§ãŒé«˜ã„
            if (pitch >= 80 && pitch <= 600) {
                recordingData.push({ values, pitch });
            }

            setTimeout(collectData, 100);
        }

        function finishRecording() {
            isRecording = false;
            document.getElementById('recordBtn').disabled = false;
            document.getElementById('recordingProgress').classList.remove('active');
            document.getElementById('recordingGuide').classList.remove('active');
            document.getElementById('recordingIndicator').style.display = 'none';

            if (audioContext) audioContext.close();

            analyzeRecording();
        }

        function analyzeRecording() {
            if (recordingData.length === 0) return;

            const avgValues = [0, 0, 0, 0, 0, 0];
            for (const frame of recordingData) {
                for (let i = 0; i < 6; i++) {
                    avgValues[i] += frame.values[i];
                }
            }
            for (let i = 0; i < 6; i++) {
                avgValues[i] /= recordingData.length;
            }

            // é«˜ã•ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã¯å®Ÿéš›ã®pitchã‹ã‚‰å†è¨ˆç®—
            // å¹³å‡ãƒ”ãƒƒãƒã‚’ä½¿ç”¨
            const avgPitch = recordingData.reduce((acc, frame) => acc + frame.pitch, 0) / recordingData.length;
            console.log('å¹³å‡ãƒ”ãƒƒãƒ:', avgPitch, 'Hz');

            // äººé–“ã®å£°åŸŸã«åˆã‚ã›ã¦æ­£è¦åŒ– - åºƒã„ç¯„å›²ï¼ˆ80-400Hzï¼‰
            // çµ±è¨ˆãƒ‡ãƒ¼ã‚¿ã‚ˆã‚Šåºƒã„ç¯„å›²ã§ç”·å¥³å…¨ä½“ã‚’ã‚«ãƒãƒ¼
            // 80Hz â†’ 0.0, 240Hz â†’ 0.5, 400Hz â†’ 1.0
            const pitchBasedHeight = Math.min(1.0, Math.max(0.0, (avgPitch - 80) / 320));
            avgValues[0] = pitchBasedHeight; // é«˜ã•ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã‚’ç½®ãæ›ãˆ

            console.log('é«˜ã•ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ (pitch-based):', pitchBasedHeight);

            // ==========================================
            // ãƒ‡ãƒ¼ã‚¿åé›†ç”¨ï¼šã™ã¹ã¦ã®ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿ã®ç”Ÿã®å€¤ã‚’å‡ºåŠ›
            // ==========================================
            console.log('\n===== ğŸ“Š ãƒ‡ãƒ¼ã‚¿åé›†ç”¨ï¼šç”Ÿã®å€¤ =====');
            console.log('ã€åŸºæœ¬æƒ…å ±ã€‘');
            console.log('  å¹³å‡ãƒ”ãƒƒãƒ:', avgPitch.toFixed(2), 'Hz');
            console.log('  ãƒ‡ãƒ¼ã‚¿æ•°:', recordingData.length, 'ãƒ•ãƒ¬ãƒ¼ãƒ ');

            // ãƒ‡ãƒãƒƒã‚°ãƒ­ã‚°ç”¨ï¼šçµ±è¨ˆãƒ™ãƒ¼ã‚¹ã®é€†ç®—å¼ã§ç”Ÿã®å€¤ã‚’è¨ˆç®—
            // avgValues[1] = (centroid + 5) / 25
            // centroid = avgValues[1] * 25 - 5
            const rawCentroid = avgValues[1] * 25 - 5;

            // avgValues[2] = rmsEnergy / 100 + 0.20
            // rmsEnergy = (avgValues[2] - 0.20) * 100
            const rawRmsEnergy = (avgValues[2] - 0.20) * 100;

            // avgValues[3] = (centroid + 2) / 20
            // centroid = avgValues[3] * 20 - 2
            const rawCentroidForGloss = avgValues[3] * 20 - 2;

            // avgValues[4] = (0.10785 - flatness) / 0.04885
            const rawFlatness = 0.10785 - avgValues[4] * 0.04885;

            // avgValues[5] = (ratio - 0.18675) / 0.09795
            const rawResonanceRatio = avgValues[5] * 0.09795 + 0.18675;

            console.log('\nã€æ­£è¦åŒ–å‰ã®ç”Ÿã®å€¤ã€‘');
            console.log('  1. é«˜ã• (Pitch):');
            console.log('     â†’ å¹³å‡ãƒ”ãƒƒãƒ:', avgPitch.toFixed(2), 'Hz');
            console.log('  2. ã‚¯ãƒªã‚¢ã• (Clarity):');
            console.log('     â†’ Norm Centroid:', rawCentroid.toFixed(2), '(Raw ~' + (rawCentroid * 8).toFixed(1) + ')');
            console.log('  3. ãƒ‘ãƒ¯ãƒ¼ (Power):');
            console.log('     â†’ RMS Energy:', rawRmsEnergy.toFixed(2));
            console.log('  4. è‰¶ (Gloss):');
            console.log('     â†’ Norm Centroid:', rawCentroidForGloss.toFixed(2), '(Raw ~' + (rawCentroidForGloss * 8).toFixed(1) + ')');
            console.log('  5. æŸ”ã‚‰ã‹ã• (Softness):');
            console.log('     â†’ Spectral Flatness:', rawFlatness.toFixed(4));
            console.log('  6. éŸ¿ã (Resonance):');
            console.log('     â†’ Mid Freq Ratio:', rawResonanceRatio.toFixed(3));

            console.log('\nã€æ­£è¦åŒ–å¾Œã®å€¤ (0.0-1.0)ã€‘');
            console.log('  1. é«˜ã•:', avgValues[0].toFixed(3));
            console.log('  2. ã‚¯ãƒªã‚¢ã•:', avgValues[1].toFixed(3));
            console.log('  3. ãƒ‘ãƒ¯ãƒ¼:', avgValues[2].toFixed(3));
            console.log('  4. è‰¶:', avgValues[3].toFixed(3));
            console.log('  5. æŸ”ã‚‰ã‹ã•:', avgValues[4].toFixed(3));
            console.log('  6. éŸ¿ã:', avgValues[5].toFixed(3));
            console.log('=====================================\n');

            // å‘¨æ³¢æ•°ãƒ‡ãƒ¼ã‚¿ã‚’å–å¾—ã—ã¦ã‚½ãƒ¼ãƒˆ
            let pitches = recordingData.map(f => f.pitch).sort((a, b) => a - b);

            console.log('åé›†ã—ãŸå‘¨æ³¢æ•°ãƒ‡ãƒ¼ã‚¿æ•°:', pitches.length);

            if (pitches.length === 0) {
                document.getElementById('statusPrecision').innerText = 'éŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
                return;
            }

            console.log('æœ€å°å‘¨æ³¢æ•°:', Math.min(...pitches), 'Hz');
            console.log('æœ€å¤§å‘¨æ³¢æ•°:', Math.max(...pitches), 'Hz');

            // ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„å ´åˆã¯IQRãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¹ã‚­ãƒƒãƒ—
            if (pitches.length < 10) {
                console.log('ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã„ãŸã‚IQRãƒ•ã‚£ãƒ«ã‚¿ã‚’ã‚¹ã‚­ãƒƒãƒ—');
            } else {
                // çµ±è¨ˆçš„å¤–ã‚Œå€¤é™¤å»ï¼ˆIQRæ³•ï¼‰- ã‚„ã‚„ç·©ã‚ã«
                const q1Index = Math.floor(pitches.length * 0.25);
                const q3Index = Math.floor(pitches.length * 0.75);
                const q1 = pitches[q1Index];
                const q3 = pitches[q3Index];
                const iqr = q3 - q1;
                const lowerBound = q1 - 2.0 * iqr;
                const upperBound = q3 + 2.0 * iqr;

                // å¤–ã‚Œå€¤ã‚’é™¤å¤–
                const beforeFilter = pitches.length;
                pitches = pitches.filter(p => p >= lowerBound && p <= upperBound);
                console.log(`IQRãƒ•ã‚£ãƒ«ã‚¿: ${beforeFilter} â†’ ${pitches.length} ãƒ‡ãƒ¼ã‚¿`);
            }

            if (pitches.length === 0) {
                document.getElementById('statusPrecision').innerText = 'æœ‰åŠ¹ãªéŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒæ¤œå‡ºã•ã‚Œã¾ã›ã‚“ã§ã—ãŸ';
                return;
            }

            console.log('ãƒ•ã‚£ãƒ«ã‚¿å¾Œã®å‘¨æ³¢æ•°ãƒ‡ãƒ¼ã‚¿æ•°:', pitches.length);

            // ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã™ãã‚‹å ´åˆã¯ã‚¨ãƒ©ãƒ¼
            if (pitches.length < 3) {
                document.getElementById('statusPrecision').innerText = 'éŸ³å£°ãƒ‡ãƒ¼ã‚¿ãŒå°‘ãªã™ãã¾ã™ã€‚ã‚‚ã£ã¨å¤§ããªå£°ã§è©±ã—ã¦ãã ã•ã„';
                return;
            }

            // éŸ³åŸŸã‚’åºƒã‚ã«æ¤œå‡ºï¼ˆ5%ile - 95%ileï¼‰
            const n = pitches.length;
            const lowIndex = Math.floor(n * 0.05); // ä¸‹ä½5%
            const highIndex = Math.floor(n * 0.95); // ä¸Šä½5%
            const lowPitch = pitches[lowIndex];
            const highPitch = pitches[highIndex];

            console.log('===== éŸ³åŸŸè¨ˆç®—ã®è©³ç´° =====');
            console.log('ãƒ‡ãƒ¼ã‚¿æ•°:', n);
            console.log('lowIndex (5%ile):', lowIndex, 'â†’', lowPitch, 'Hz');
            console.log('highIndex (95%ile):', highIndex, 'â†’', highPitch, 'Hz');
            console.log('ãƒ”ãƒƒãƒãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€åˆ5å€‹ï¼‰:', pitches.slice(0, 5));
            console.log('ãƒ”ãƒƒãƒãƒ‡ãƒ¼ã‚¿ã®ã‚µãƒ³ãƒ—ãƒ«ï¼ˆæœ€å¾Œ5å€‹ï¼‰:', pitches.slice(-5));

            // åŒä¸€å€¤ãƒã‚§ãƒƒã‚¯
            if (lowPitch === highPitch) {
                console.warn('âš ï¸ è­¦å‘Š: lowPitch ã¨ highPitch ãŒåŒã˜å€¤ã§ã™ï¼');
                console.log('å…¨ãƒ”ãƒƒãƒãƒ‡ãƒ¼ã‚¿:', pitches);
            }

            const semitones = calculateSemitones(lowPitch, highPitch);
            console.log('éŸ³åŸŸå¹…:', semitones, 'åŠéŸ³');

            // éŸ³åŸŸãŒ0åŠéŸ³ã§ã‚‚ç¶šè¡Œï¼ˆæ™®é€šã«è©±ã™å£°ã§ã¯ã‚ã‚Šå¾—ã‚‹ï¼‰
            // è¡¨ç¤ºç”¨ã«æœ€ä½1åŠéŸ³ã¨ã—ã¦æ‰±ã†
            const displaySemitones = Math.max(1, semitones);

            const voiceColor = calculateVoiceColor(avgValues);
            const hsl = `hsl(${voiceColor.hue}, ${voiceColor.saturation}%, ${voiceColor.lightness}%)`;
            const hex = hslToHex(voiceColor.hue, voiceColor.saturation, voiceColor.lightness);

            // ã‚°ãƒ©ãƒ•æç”»
            drawBasePrecision();
            ctxPrecision.beginPath();
            const grad = ctxPrecision.createRadialGradient(centerX, centerY, 0, centerX, centerY, maxRadius);
            grad.addColorStop(0, 'rgba(255, 255, 255, 0.9)');
            grad.addColorStop(1, `hsla(${voiceColor.hue}, ${voiceColor.saturation}%, ${Math.min(80, voiceColor.lightness + 10)}%, 0.6)`);
            ctxPrecision.fillStyle = grad;
            ctxPrecision.strokeStyle = `hsl(${voiceColor.hue}, ${voiceColor.saturation}%, ${Math.max(35, voiceColor.lightness - 15)}%)`;
            ctxPrecision.lineWidth = 3;

            for (let i = 0; i < numPoints; i++) {
                const angle = (Math.PI * 2 / numPoints) * i - Math.PI / 2;
                const val = Math.max(0.2, avgValues[i]);
                const x = centerX + (maxRadius * val) * Math.cos(angle);
                const y = centerY + (maxRadius * val) * Math.sin(angle);
                if (i === 0) ctxPrecision.moveTo(x, y);
                else ctxPrecision.lineTo(x, y);
            }
            ctxPrecision.closePath();
            ctxPrecision.fill();
            ctxPrecision.stroke();

            // è‰²è¡¨ç¤º
            console.log('è‰²ã‚’è¨­å®š:', hsl, hex);
            document.getElementById('colorDisplayPrecision').style.backgroundColor = hsl;
            document.getElementById('colorValuePrecision').innerText = `è‰²ç›¸:${voiceColor.hue}Â° å½©åº¦:${voiceColor.saturation}% æ˜åº¦:${voiceColor.lightness}%`;
            document.getElementById('colorHexPrecision').innerText = hex;

            // éŸ³åŸŸè¡¨ç¤º
            const highNote = frequencyToNote(highPitch);
            const lowNote = frequencyToNote(lowPitch);
            document.getElementById('highestNote').innerText = highNote;
            document.getElementById('lowestNote').innerText = lowNote;
            document.getElementById('vocalRange').innerText = displaySemitones + 'åŠéŸ³';
            document.getElementById('voiceType').innerText = determineVoiceType(avgValues, lowPitch, highPitch);

            // éŸ³åŸŸãƒãƒ¼
            drawVocalRangeBar(lowPitch, highPitch, lowNote, highNote);

            // ãƒ‘ãƒ©ãƒ¡ãƒ¼ã‚¿è©³ç´°ã‚’æ›´æ–°
            const paramNames = ['height', 'clarity', 'power', 'gloss', 'softness', 'resonance'];
            avgValues.forEach((value, index) => {
                const percentage = Math.round(value * 100);
                document.getElementById(`param-${paramNames[index]}`).innerText = `${percentage}%`;
                document.getElementById(`bar-${paramNames[index]}`).style.width = `${percentage}%`;
            });

            // ãŠã™ã™ã‚æ›²
            recommendSongs(lowPitch, highPitch);

            document.getElementById('precisionResult').classList.add('active');
        }

        // å‘¨æ³¢æ•°â†’éŸ³å
        function frequencyToNote(freq) {
            const A4 = 440;
            const C0 = A4 * Math.pow(2, -4.75);
            const noteNames = ['C', 'C#', 'D', 'D#', 'E', 'F', 'F#', 'G', 'G#', 'A', 'A#', 'B'];
            const h = Math.round(12 * Math.log2(freq / C0));
            const octave = Math.floor(h / 12);
            const n = h % 12;
            return noteNames[n] + octave;
        }

        // åŠéŸ³æ•°è¨ˆç®—
        function calculateSemitones(f1, f2) {
            return Math.round(Math.abs(12 * Math.log2(f2 / f1)));
        }

        // å£°è³ªã‚¿ã‚¤ãƒ—åˆ¤å®š
        function determineVoiceType(values, lowPitch, highPitch) {
            const avgPitch = (lowPitch + highPitch) / 2;
            if (avgPitch < 150) return 'ä½ãåŠ›å¼·ã„ãƒã‚¹ãƒ»ãƒãƒªãƒˆãƒ³';
            if (avgPitch < 250) return 'ãƒãƒ©ãƒ³ã‚¹ã®è‰¯ã„ãƒ†ãƒŠãƒ¼ãƒ»ã‚¢ãƒ«ãƒˆ';
            return 'æ˜ã‚‹ãé«˜ã„ã‚½ãƒ—ãƒ©ãƒãƒ»ãƒ¡ã‚¾ã‚½ãƒ—ãƒ©ãƒ';
        }

        // éŸ³åŸŸãƒãƒ¼æç”»
        function drawVocalRangeBar(lowPitch, highPitch, lowNote, highNote) {
            const bar = document.getElementById('rangeBar');
            bar.innerHTML = '';

            const C0 = 16.35;
            const lowSemi = Math.round(12 * Math.log2(lowPitch / C0));
            const highSemi = Math.round(12 * Math.log2(highPitch / C0));
            const rangeStart = 24;
            const rangeEnd = 84;
            const rangeWidth = rangeEnd - rangeStart;

            const lowPos = Math.max(0, Math.min(100, ((lowSemi - rangeStart) / rangeWidth) * 100));
            const highPos = Math.max(0, Math.min(100, ((highSemi - rangeStart) / rangeWidth) * 100));

            const lowMarker = document.createElement('div');
            lowMarker.className = 'range-marker';
            lowMarker.style.left = lowPos + '%';
            lowMarker.style.background = '#1dd1a1';
            const lowLabel = document.createElement('div');
            lowLabel.className = 'range-label';
            lowLabel.innerText = lowNote;
            lowLabel.style.left = lowPos + '%';
            lowLabel.style.top = '65px';
            lowLabel.style.color = '#1dd1a1';
            lowMarker.appendChild(lowLabel);

            const highMarker = document.createElement('div');
            highMarker.className = 'range-marker';
            highMarker.style.left = highPos + '%';
            highMarker.style.background = '#ff6b6b';
            const highLabel = document.createElement('div');
            highLabel.className = 'range-label';
            highLabel.innerText = highNote;
            highLabel.style.left = highPos + '%';
            highLabel.style.top = '-25px';
            highLabel.style.color = '#ff6b6b';
            highMarker.appendChild(highLabel);
            bar.appendChild(lowMarker);
            bar.appendChild(highMarker);
        }

        // ========================================
        // æ¥½æ›²ãƒ‡ãƒ¼ã‚¿ãƒ™ãƒ¼ã‚¹ï¼ˆ50æ›²ç‰ˆï¼‰
        // ========================================
        // ã™ã¹ã¦ã®éŸ³åŸŸãƒ‡ãƒ¼ã‚¿ã¯Webæ¤œç´¢ã§ç¢ºèªæ¸ˆã¿ï¼ˆvocal-range.comã€stepupkaraoke.comç­‰ï¼‰
        // YouTube IDã¯å…¬å¼MV IDã‚’ä½¿ç”¨ï¼ˆ2026å¹´1æœˆç¢ºèªæ¸ˆã¿ï¼‰
        // C#3ã€œC4ï¼ˆ139-262Hzï¼‰éŸ³åŸŸã‚’é‡ç‚¹çš„ã«é…ç½®ï¼ˆ35æ›²ä»¥ä¸Šï¼‰

        const songDB = [
            // ============================================
            // ğŸŸ¥ è¶…ä½éŸ³åŸŸã€œä½éŸ³åŸŸ (Super Low ~ Bass) F2-E3
            // ============================================
            { title: "Wozwald (Cover)", artist: "å®®ä¸‹éŠ", low: 55, high: 330, range: "A1-E4", yt: "wozwald_miyashita" }, // ä»®ã‚­ãƒ¼
            { title: "å®¶æ—ã«ãªã‚ã†ã‚ˆ", artist: "ç¦å±±é›…æ²»", low: 73, high: 293, range: "D2-D4", yt: "gyS6eXW0zJw" },
            { title: "Squall", artist: "ç¦å±±é›…æ²»", low: 82, high: 330, range: "E2-E4", yt: "M7U5MF5bG5k" },
            { title: "The Hole", artist: "King Gnu", low: 87, high: 440, range: "F2-A4", yt: "fpr1qFqjLz4" },
            { title: "ã¾ã¡ãŒã„ã•ãŒã—", artist: "è…ç”°å°†æš‰", low: 98, high: 494, range: "G2-B4", yt: "WP83Cws62n0" },
            { title: "ç™½æ—¥", artist: "King Gnu", low: 117, high: 494, range: "A#2-B4", yt: "ony539T074w" },
            { title: "é¦™æ°´", artist: "ç‘›äºº", low: 117, high: 415, range: "A#2-G#4", yt: "3ULp7GQSz_M" },
            { title: "æ€ªç£ã®èŠ±å”„", artist: "Vaundy", low: 123, high: 440, range: "B2-A4", yt: "UM9XNpgrq08" },
            { title: "Lemon", artist: "ç±³æ´¥ç„å¸«", low: 123, high: 494, range: "B2-B4", yt: "SX_ViT4Ra7k" },

            // ============================================
            // ğŸŸ¨ ä¸­ä½éŸ³åŸŸ (Mid-Low / Baritone) F3-B3
            // ============================================
            { title: "KICK BACK", artist: "ç±³æ´¥ç„å¸«(ãƒã‚§ãƒ³ã‚½ãƒ¼ãƒãƒ³)", low: 130, high: 523, range: "C3-C5", yt: "M2cckDmNLMI" },
            { title: "Bling-Bang-Bang-Born", artist: "Creepy Nuts", low: 130, high: 440, range: "C3-A4", yt: "mLW35YMzELE" },
            { title: "ç¬¬ã‚¼ãƒ­æ„Ÿ", artist: "10-FEET(ã‚¹ãƒ©ãƒ ãƒ€ãƒ³ã‚¯)", low: 130, high: 466, range: "C3-A#4", yt: "EsJSt8qSKTM" },
            { title: "ç³ã‚’ã¨ã˜ã¦", artist: "å¹³äº•å …", low: 131, high: 415, range: "C3-G#4", yt: "NfWe8uGnUkA" },
            { title: "å¤©ä½“è¦³æ¸¬", artist: "BUMP OF CHICKEN", low: 131, high: 494, range: "C3-B4", yt: "j7CDb610Bg0" },
            { title: "Love so sweet", artist: "åµ", low: 147, high: 523, range: "D3-C5", yt: "oQ3JSKyOv8Q" },
            { title: "Pretender", artist: "Officialé«­ç”·dism", low: 156, high: 523, range: "D#3-C5", yt: "TQ8WlA2GXbk" },
            { title: "ã‚·ãƒ£ãƒ«ãƒ«", artist: "ãƒãƒ«ãƒ¼ãƒ³(Vocaloid)", low: 156, high: 523, range: "D#3-C5", yt: "TA5OFS_y9CA" },
            { title: "ãƒ­ã‚­", artist: "ã¿ãã¨P(Vocaloid)", low: 156, high: 494, range: "D#3-B4", yt: "Xg-qfsKN2_E" },
            { title: "ä¸€é€”", artist: "King Gnu(å‘ªè¡“å»»æˆ¦)", low: 165, high: 622, range: "E3-D#5", yt: "hm1na9uw2sc" },
            { title: "ç´…è“®è¯", artist: "LiSA(é¬¼æ»…ã®åˆƒ)", low: 165, high: 587, range: "E3-D5", yt: "CwkzK-F0Y00" },

            // ============================================
            // ğŸŸ© ä¸­é«˜éŸ³åŸŸ (Mid-High / Tenor-Alto) C4-E4
            // ============================================
            { title: "ç‚", artist: "LiSA(é¬¼æ»…ã®åˆƒ)", low: 185, high: 659, range: "F#3-E5", yt: "4Q9DWZLaY2U" },
            { title: "ãƒŸãƒƒã‚¯ã‚¹ãƒŠãƒƒãƒ„", artist: "Officialé«­ç”·dism(SpyFamily)", low: 185, high: 587, range: "F#3-D5", yt: "CbH2F0kXgTY" },
            { title: "ãƒãƒªãƒ¼ã‚´ãƒ¼ãƒ«ãƒ‰", artist: "ã‚ã„ã¿ã‚‡ã‚“", low: 185, high: 494, range: "F#3-B4", yt: "0xSiBpUdW4E" },
            { title: "å¤œã«é§†ã‘ã‚‹", artist: "YOASOBI", low: 196, high: 698, range: "G3-F5", yt: "x8VYWazR5mE" },
            { title: "ç¾¤é’", artist: "YOASOBI", low: 196, high: 659, range: "G3-E5", yt: "Y4nEEZwckuU" },
            { title: "æ®‹éŸ¿æ•£æ­Œ", artist: "Aimer(é¬¼æ»…ã®åˆƒ)", low: 196, high: 622, range: "G3-D#5", yt: "tLQLa6lM3Us" },
            { title: "ç¥ã£ã½ã„ãª", artist: "ãƒ”ãƒã‚­ã‚ªãƒ”ãƒ¼(Vocaloid)", low: 196, high: 587, range: "G3-D5", yt: "EHBFKhLUVig" },
            { title: "åƒæœ¬æ¡œ", artist: "WhiteFlame(Vocaloid)", low: 196, high: 587, range: "G3-D5", yt: "shs0rAiwsGQ" },
            { title: "ã‚­ãƒ³ã‚°", artist: "Kanaria(Vocaloid)", low: 196, high: 587, range: "G3-D5", yt: "cm-l2h6GB8Q" },
            { title: "ãƒ™ãƒãƒ ", artist: "ã‹ã„ã‚Šããƒ™ã‚¢(Vocaloid)", low: 196, high: 523, range: "G3-C5", yt: "oRJBwaZ59fQ" },
            { title: "æ®‹é…·ãªå¤©ä½¿ã®ãƒ†ãƒ¼ã‚¼", artist: "é«˜æ©‹æ´‹å­(ã‚¨ãƒ´ã‚¡)", low: 220, high: 523, range: "A3-C5", yt: "nU21rCWkuJw" },
            { title: "ã†ã£ã›ã‡ã‚", artist: "Ado", low: 220, high: 659, range: "A3-E5", yt: "Qp3b-RXtz4w" },

            // ============================================
            // ğŸŸ¦ é«˜éŸ³åŸŸã€œè¶…é«˜éŸ³åŸŸ (High / Soprano) F4+
            // ============================================
            { title: "ã‚¢ã‚¤ãƒ‰ãƒ«", artist: "YOASOBI(æ¨ã—ã®å­)", low: 233, high: 1046, range: "A#3-C6", yt: "ZRtdQ81jPUQ" }, // ãƒ©ãƒƒãƒ—ãƒ‘ãƒ¼ãƒˆé™¤ããƒ¡ã‚¤ãƒ³éŸ³åŸŸ
            { title: "ãƒ´ã‚¡ãƒ³ãƒ‘ã‚¤ã‚¢", artist: "DECO*27(Vocaloid)", low: 246, high: 698, range: "B3-F5", yt: "e1xCOsgWg0M" },
            { title: "æ–°æ™‚ä»£", artist: "Ado(ONE PIECE)", low: 246, high: 987, range: "B3-B5", yt: "1FliVTcX8bQ" },
            { title: "ç§ã¯æœ€å¼·", artist: "Ado(ONE PIECE)", low: 220, high: 880, range: "A3-A5", yt: "sk1Z-Hqwwog" },
            { title: "ãƒ•ã‚©ãƒ‹ã‚¤", artist: "ãƒ„ãƒŸã‚­(Vocaloid)", low: 261, high: 698, range: "C4-F5", yt: "9QLT1Aw_45s" },
            { title: "ã‚´ãƒ¼ã‚¹ãƒˆãƒ«ãƒ¼ãƒ«", artist: "DECO*27(Vocaloid)", low: 261, high: 783, range: "C4-G5", yt: "K7yu52v1i3s" },
            { title: "ã‚¨ã‚¤ãƒªã‚¢ãƒ³ã‚¨ã‚¤ãƒªã‚¢ãƒ³", artist: "ãƒŠãƒ¦ã‚¿ãƒ³æ˜Ÿäºº(Vocaloid)", low: 261, high: 698, range: "C4-F5", yt: "w-g92gI1Lgw" },
            { title: "ã‚±ã‚»ãƒ©ã‚»ãƒ©", artist: "Mrs. GREEN APPLE", low: 165, high: 783, range: "E3-G5", yt: "UH8Rjo1l5E0" }, // ç”·æ€§ã ãŒè¶…é«˜éŸ³
            { title: "å‘½ã«å«Œã‚ã‚Œã¦ã„ã‚‹ã€‚", artist: "ã‚«ãƒ³ã‚¶ã‚­ã‚¤ã‚ªãƒª(Vocaloid)", low: 220, high: 698, range: "A3-F5", yt: "0HYm60Mjm0k" },
            { title: "ã‚¢ã‚¹ãƒãƒ¨ã‚¾ãƒ©å“¨æˆ’ç­", artist: "Orangestar(Vocaloid)", low: 261, high: 783, range: "C4-G5", yt: "XogSflwXgpw" },
            { title: "ãƒ­ã‚¹ãƒˆãƒ¯ãƒ³ã®å·å“­", artist: "Neru(Vocaloid)", low: 293, high: 830, range: "D4-G#5", yt: "02onNieIWjg" },
            { title: "åˆéŸ³ãƒŸã‚¯ã®æ¶ˆå¤±", artist: "cosMo@æš´èµ°P", low: 293, high: 1396, range: "D4-F6", yt: "2XpucCE51tA" } // è¶…é«˜é€Ÿãƒ»è¶…é«˜éŸ³
        ];

        // ========================================
        // æ¥½æ›²æ¨è–¦ã‚¢ãƒ«ã‚´ãƒªã‚ºãƒ ï¼ˆéŸ³åŸŸå†…é »å‡ºåº¦é‡è¦–ï¼‰
        // ========================================
        function recommendSongs(userLow, userHigh) {
            const recs = [];
            const userRange = userHigh - userLow;

            for (const song of songDB) {
                // éŸ³åŸŸã®é‡ãªã‚Šéƒ¨åˆ†ã‚’è¨ˆç®—
                const overlapLow = Math.max(userLow, song.low);
                const overlapHigh = Math.min(userHigh, song.high);
                const overlap = Math.max(0, overlapHigh - overlapLow);

                if (overlap > 0) {
                    const songRange = song.high - song.low;

                    // ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éŸ³åŸŸå†…ã«æ›²ã®éŸ³åŸŸãŒã©ã‚Œã ã‘å«ã¾ã‚Œã‚‹ã‹
                    const userCoverageRatio = overlap / userRange;

                    // æ›²ã®éŸ³åŸŸå†…ã«ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éŸ³åŸŸãŒã©ã‚Œã ã‘å«ã¾ã‚Œã‚‹ã‹
                    const songCoverageRatio = overlap / songRange;

                    // ä¸¡æ–¹ã‚’è€ƒæ…®ã—ãŸã‚¹ã‚³ã‚¢ï¼ˆãƒ¦ãƒ¼ã‚¶ãƒ¼éŸ³åŸŸå†…ã®é »å‡ºåº¦ã‚’é‡è¦–ï¼‰
                    // userCoverageRatio: ãƒ¦ãƒ¼ã‚¶ãƒ¼ã®éŸ³åŸŸã‚’ã©ã‚Œã ã‘ã‚«ãƒãƒ¼ã™ã‚‹ã‹ï¼ˆ60%é‡è¦–ï¼‰
                    // songCoverageRatio: æ›²ã®éŸ³åŸŸã‚’ã©ã‚Œã ã‘ã‚«ãƒãƒ¼ã§ãã‚‹ã‹ï¼ˆ40%é‡è¦–ï¼‰
                    const score = Math.round((userCoverageRatio * 0.6 + songCoverageRatio * 0.4) * 100);

                    if (score > 20) {  // 20%ä»¥ä¸Šã®ãƒãƒƒãƒãƒ³ã‚°ç‡ã§è¡¨ç¤º
                        recs.push({ ...song, score });
                    }
                }
            }

            // ã‚¹ã‚³ã‚¢ã®é«˜ã„é †ã«ã‚½ãƒ¼ãƒˆ
            recs.sort((a, b) => b.score - a.score);

            const list = document.getElementById('songList');
            list.innerHTML = '';

            if (recs.length === 0) {
                list.innerHTML = '<div style="padding: 10px; color: #666;">ãƒãƒƒãƒã™ã‚‹æ›²ãŒè¦‹ã¤ã‹ã‚Šã¾ã›ã‚“ã§ã—ãŸ</div>';
            } else {
                recs.slice(0, 10).forEach(song => {
                    const item = document.createElement('div');
                    item.className = 'song-item';
                    item.innerHTML = `

                        <div class="song-info">
                            <div class="song-title">${song.title}</div>
                            <div class="song-artist">${song.artist} (${song.range})</div>
                        </div>
                        <div style="display: flex; align-items: center; gap: 10px;">
                            <div class="song-match">${song.score}%</div>
                            <a href="https://www.youtube.com/results?search_query=${encodeURIComponent(song.artist + ' ' + song.title)}" target="_blank" rel="noopener noreferrer" style="text-decoration: none; padding: 5px 12px; font-size: 0.85rem; background: #ff0000; color: white; border: none; border-radius: 5px; cursor: pointer; display: inline-block;">
                                â–¶ YouTube
                            </a>
                        </div>
                    `;
                    list.appendChild(item);
                });
            }
            document.getElementById('songRecommendations').style.display = 'block';
        }

        // åˆæœŸåŒ–
        drawBase(ctx);
        drawBasePrecision();
    </script>
</body>


</html>
